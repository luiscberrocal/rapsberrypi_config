- name: Only run "update_cache=yes" if the last one is more than 3600 seconds ago
  become: yes
  apt:
    update_cache: yes
    cache_valid_time: 3600
- name: Setting variables
  set_fact:
    docker_gpg_key: "./output/docker_gpg.txt"
    download_url: " https://download.docker.com/linux/raspbian"
- name: Install required system packages
  become: yes
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: no
  loop: [ 'vim', 'apt-transport-https', 'ca-certificates', 'curl', 'software-properties-common', 'gnupg-agent']
- name: Download GPG key
  get_url:
    url: "{{ download_url }}/gpg"
    dest: "{{ docker_gpg_key }}"
- name: Add Apt signing key on remote server to keyring
  become: yes
  apt_key:
    file: "{{ docker_gpg_key }}"
    state: present
- name: Get lsb release
  shell: lsb_release -cs
  register: lsb_release
- name: Add specified repository into sources list
  become: yes
  apt_repository:
    repo: "deb [arch=armhf] {{download_url}} {{lsb_release}} stable"
    state: present
- name: Install Docker pakages
  become: yes
  apt:
    name: "{{ item }}"
    state: latest
    update_cache: yes
  loop: [ 'docker-ce', 'docker-ce-cli', 'containerd.io']
